<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pr谩ctica: Segundo Parcial GRI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .container-card {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1),
                        0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .button-correct,
        .button-incorrect {
            transition: all 0.15s ease-in-out;
        }
        .button-correct:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.5);
        }
        .button-incorrect:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.5);
        }
    </style>
</head>
<body>

<div id="app" class="min-h-screen flex flex-col items-center justify-center p-4">
    <div class="w-full max-w-lg bg-white rounded-xl p-8 container-card">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">
            Segundo Parcial GRI 
        </h1>
        
        <!-- Carga del Archivo CSV -->
        <div id="file-upload-section" class="mb-8 p-4 border-2 border-dashed border-indigo-300 rounded-lg bg-indigo-50">
            <p class="text-center text-sm text-gray-700 mb-3">
                Pod茅s subir otro CSV si quer茅s cambiar las preguntas (formato: Afirmaci贸n;Respuesta)
            </p>
            <input
                type="file"
                id="csv-file-input"
                accept=".csv"
                class="w-full text-sm text-gray-500
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-full file:border-0
                    file:text-sm file:font-semibold
                    file:bg-indigo-500 file:text-white
                    hover:file:bg-indigo-600"
            />
        </div>

        <!-- Secci贸n del Quiz -->
        <div id="quiz-section" class="hidden">
            <!-- Puntuaci贸n y Progreso + stats en vivo -->
            <div class="mb-4 p-3 bg-gray-100 rounded-lg">
                <div class="flex justify-between items-center">
                    <p class="text-lg font-semibold text-gray-700">
                        Puntuaci贸n:
                        <span id="current-score" class="text-indigo-600">0</span>
                        / 50
                    </p>
                    <p class="text-lg font-semibold text-gray-700">
                        Pregunta:
                        <span id="current-progress" class="text-indigo-600">0 / 50</span>
                    </p>
                </div>
                <div class="mt-2 text-sm text-gray-600 flex justify-between">
                    <span>
                        Correctas:
                        <span id="live-correct" class="font-semibold text-emerald-600">0</span>
                    </span>
                    <span>
                        Incorrectas:
                        <span id="live-incorrect" class="font-semibold text-rose-600">0</span>
                    </span>
                    <span>
                        Omitidas:
                        <span id="live-skipped" class="font-semibold text-gray-700">0</span>
                    </span>
                </div>
            </div>

            <!-- Pregunta -->
            <div
                id="question-card"
                class="bg-indigo-50 p-6 rounded-xl border-t-4 border-indigo-500 min-h-[150px] flex items-center justify-center"
            >
                <p id="question-text" class="text-xl font-medium text-gray-800 text-center">
                    Cargando pregunta...
                </p>
            </div>

            <!-- Botones -->
            <div class="mt-8 grid grid-cols-3 gap-3">
                <button
                    onclick="handleAnswer('Verdadero')"
                    class="button-correct py-3 rounded-xl text-white font-bold bg-emerald-500 hover:bg-emerald-600 focus:outline-none focus:ring-4 focus:ring-emerald-300"
                >
                    Verdadero
                </button>
                <button
                    onclick="handleAnswer('Falso')"
                    class="button-incorrect py-3 rounded-xl text-white font-bold bg-rose-500 hover:bg-rose-600 focus:outline-none focus:ring-4 focus:ring-rose-300"
                >
                    Falso
                </button>
                <button
                    onclick="handleAnswer('Omitir')"
                    class="py-3 rounded-xl text-gray-700 font-bold bg-gray-200 hover:bg-gray-300 focus:outline-none focus:ring-4 focus:ring-gray-300"
                >
                    Omitir
                </button>
            </div>

            <!-- Feedback -->
            <div
                id="feedback-message"
                class="mt-4 p-3 rounded-lg text-center font-semibold hidden"
            ></div>
        </div>

        <!-- Resultados -->
        <div
            id="results-section"
            class="hidden text-center p-6 bg-green-50 rounded-xl border-t-4 border-green-500"
        >
            <h2 class="text-2xl font-bold text-green-700 mb-3">Examen terminado!</h2>
            <p class="text-xl text-gray-800 mb-2">
                Puntuaci贸n Final:
                <span id="final-score" class="text-4xl font-extrabold text-green-600">0</span>
                / 50
            </p>
            <p class="text-lg text-gray-800 mb-4">
                Nota final (sobre 10):
                <span id="final-grade" class="text-3xl font-bold text-indigo-600">-</span>
            </p>
            <p class="text-md text-gray-600">Estad铆sticas:</p>
            <ul class="list-disc list-inside mt-2 mx-auto inline-block text-left">
                <li>Correctas: <span id="stat-correct" class="font-bold">0</span></li>
                <li>Incorrectas: <span id="stat-incorrect" class="font-bold">0</span></li>
                <li>Omitidas: <span id="stat-skipped" class="font-bold">0</span></li>
            </ul>
            <button
                onclick="location.reload()"
                class="mt-6 py-2 px-6 rounded-full text-white font-bold bg-indigo-500 hover:bg-indigo-600 focus:outline-none focus:ring-4 focus:ring-indigo-300"
            >
                Empezar nuevo intento!
            </button>
        </div>

        <!-- Error -->
        <div
            id="error-message"
            class="hidden mt-4 p-4 rounded-lg bg-red-100 text-red-700 font-medium"
        ></div>
    </div>
</div>

<script>
    const MAX_QUESTIONS = 50;

    let allQuestions = [];
    let quizQuestions = [];
    let currentQuestionIndex = 0;
    let score = 0; // puede ir de -50 a 50
    let stats = { correct: 0, incorrect: 0, skipped: 0 };
    let isQuizActive = false;

    const csvFileInput = document.getElementById('csv-file-input');
    const fileUploadSection = document.getElementById('file-upload-section');
    const quizSection = document.getElementById('quiz-section');
    const resultsSection = document.getElementById('results-section');
    const questionText = document.getElementById('question-text');
    const currentScoreSpan = document.getElementById('current-score');
    const currentProgressSpan = document.getElementById('current-progress');
    const feedbackMessage = document.getElementById('feedback-message');
    const errorMessage = document.getElementById('error-message');
    const liveCorrectSpan = document.getElementById('live-correct');
    const liveIncorrectSpan = document.getElementById('live-incorrect');
    const liveSkippedSpan = document.getElementById('live-skipped');

    function displayError(message) {
        errorMessage.textContent = message;
        errorMessage.classList.remove('hidden');
    }

    function getRandomElements(arr, num) {
        const shuffled = [...arr].sort(() => 0.5 - Math.random());
        return shuffled.slice(0, num);
    }

    function updateLiveStats() {
        currentScoreSpan.textContent = score;
        liveCorrectSpan.textContent = stats.correct;
        liveIncorrectSpan.textContent = stats.incorrect;
        liveSkippedSpan.textContent = stats.skipped;
    }

    function initQuizFromQuestions(questions) {
        if (!questions || questions.length === 0) {
            displayError("No se encontraron preguntas v谩lidas en el CSV.");
            return;
        }

        if (questions.length < MAX_QUESTIONS) {
            displayError(
                `Advertencia: solo se encontraron ${questions.length} preguntas. Se utilizar谩n todas ellas.`
            );
            quizQuestions = [...questions];
        } else {
            quizQuestions = getRandomElements(questions, MAX_QUESTIONS);
        }

        score = 0;
        currentQuestionIndex = 0;
        stats = { correct: 0, incorrect: 0, skipped: 0 };
        isQuizActive = true;

        quizSection.classList.remove('hidden');
        errorMessage.classList.add('hidden');

        updateLiveStats();
        displayQuestion();
    }

    function parseCSV(csvText) {
        const lines = csvText
            .split("\n")
            .map(line => line.trim())
            .filter(line => line !== "");
        const questions = [];

        lines.forEach(line => {
            const columns = line.split(";").map(col => col.trim());
            if (columns && columns.length >= 2) {
                const statement = columns[0].replace(/"/g, "");
                const answer = columns[1].toLowerCase();
                if (statement && (answer === "verdadero" || answer === "falso")) {
                    questions.push({
                        statement: statement,
                        correctAnswer: answer === "verdadero"
                    });
                }
            }
        });

        return questions;
    }

    async function loadDefaultCSV() {
        try {
            const response = await fetch("preguntas.csv");
            if (!response.ok) {
                throw new Error("No se pudo cargar preguntas.csv");
            }
            const text = await response.text();
            allQuestions = parseCSV(text);
            initQuizFromQuestions(allQuestions);
        } catch (error) {
            console.error(error);
            displayError(
                "No se pudo cargar el archivo preguntas.csv. Verific谩 que exista en la ra铆z del repo."
            );
        }
    }

    function displayQuestion() {
        if (currentQuestionIndex < quizQuestions.length) {
            const question = quizQuestions[currentQuestionIndex];
            questionText.textContent = question.statement;
            currentProgressSpan.textContent = `${currentQuestionIndex + 1} / ${quizQuestions.length}`;
            feedbackMessage.classList.add("hidden");
        } else {
            endQuiz();
        }
    }

    function handleAnswer(userChoice) {
        if (!isQuizActive || currentQuestionIndex >= quizQuestions.length) return;

        const question = quizQuestions[currentQuestionIndex];
        let points = 0;
        let message = "";

        if (userChoice === "Omitir") {
            points = 0;
            stats.skipped++;
            message = "Has omitido la pregunta. Puntuaci贸n: +0.";
            feedbackMessage.classList.remove("bg-red-100", "bg-green-100", "text-red-700", "text-green-700");
            feedbackMessage.classList.add("bg-gray-200", "text-gray-700");
        } else {
            const choiceIsCorrect = userChoice === "Verdadero";
            if (choiceIsCorrect === question.correctAnswer) {
                points = 1; // correcta suma 1
                score += points;
                stats.correct++;
                message = `隆Correcto! Respuesta: ${
                    question.correctAnswer ? "Verdadero" : "Falso"
                }. (+1)`;
                feedbackMessage.classList.remove(
                    "bg-red-100",
                    "bg-gray-200",
                    "text-gray-700",
                    "text-red-700"
                );
                feedbackMessage.classList.add("bg-green-100", "text-green-700");
            } else {
                points = -1; // incorrecta resta 1
                score += points;
                stats.incorrect++;
                message = `Incorrecto. La correcta era: ${
                    question.correctAnswer ? "Verdadero" : "Falso"
                }. (-1)`;
                feedbackMessage.classList.remove(
                    "bg-green-100",
                    "bg-gray-200",
                    "text-gray-700",
                    "text-green-700"
                );
                feedbackMessage.classList.add("bg-red-100", "text-red-700");
            }
        }

        updateLiveStats();
        feedbackMessage.textContent = message;
        feedbackMessage.classList.remove("hidden");

        setTimeout(() => {
            currentQuestionIndex++;
            displayQuestion();
        }, 800);
    }

    function calcularNotaFinal(puntaje) {
        // F贸rmula: 4 + (puntaje - 30) * 3 / 10
        let nota = 4 + (puntaje - 30) * 3 / 10;

        // Limitar entre 1 y 10 por prolijidad
        if (nota < 1) nota = 1;
        if (nota > 10) nota = 10;

        return nota.toFixed(1);
    }

    function endQuiz() {
        isQuizActive = false;
        quizSection.classList.add("hidden");
        resultsSection.classList.remove("hidden");
        feedbackMessage.classList.add("hidden");

        document.getElementById("final-score").textContent = score;
        document.getElementById("stat-correct").textContent = stats.correct;
        document.getElementById("stat-incorrect").textContent = stats.incorrect;
        document.getElementById("stat-skipped").textContent = stats.skipped;

        const notaFinal = calcularNotaFinal(score);
        document.getElementById("final-grade").textContent = notaFinal;
    }

    // Carga inicial desde preguntas.csv
    document.addEventListener("DOMContentLoaded", () => {
        loadDefaultCSV();
    });

    // Upload opcional para reemplazar el banco
    csvFileInput.addEventListener("change", event => {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = e => {
            try {
                allQuestions = parseCSV(e.target.result);
                initQuizFromQuestions(allQuestions);
            } catch (error) {
                console.error("Error al procesar el archivo:", error);
                displayError(
                    "Error al leer o procesar el archivo CSV. Aseg煤rate de que el formato sea correcto (Afirmaci贸n;Respuesta)."
                );
            }
        };
        reader.readAsText(file);
    });
</script>
</body>
</html>