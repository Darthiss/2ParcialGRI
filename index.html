<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PrÃ¡ctica: Parciales GRI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .container-card {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1),
                        0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .button-correct,
        .button-incorrect {
            transition: all 0.15s ease-in-out;
        }
        .button-correct:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.5);
        }
        .button-incorrect:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.5);
        }
    </style>
</head>
<body>

<div id="app" class="min-h-screen flex flex-col items-center justify-center p-4">
    <div class="w-full max-w-lg bg-white rounded-xl p-8 container-card relative">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">
            PrÃ¡ctica Parciales GRI ðŸ¤“
        </h1>

        <!-- Label de examen actual -->
        <p id="current-exam-label" class="text-center text-xs text-gray-500 mb-4"></p>
        
        <!-- MenÃº burger -->
        <div class="flex justify-end mb-4 relative">
            <button
                id="menu-button"
                aria-label="Abrir menÃº"
                class="px-3 py-2 rounded-md bg-indigo-500 text-white hover:bg-indigo-600 transition flex items-center justify-center"
            >
                â˜°
            </button>
            <div
                id="menu-dropdown"
                class="hidden absolute right-0 mt-2 w-52 bg-white border border-gray-200 rounded-lg shadow-lg text-sm z-20"
            >
                <button
                    type="button"
                    onclick="triggerUpload()"
                    class="w-full text-left px-4 py-2 hover:bg-gray-100"
                >
                    Subir archivo personalizado
                </button>
                <button
                    type="button"
                    onclick="changeExam()"
                    class="w-full text-left px-4 py-2 hover:bg-gray-100"
                >
                    Cambiar examen
                </button>
                <button
                    type="button"
                    onclick="resetQuiz()"
                    class="w-full text-left px-4 py-2 hover:bg-gray-100"
                >
                    Reiniciar examen
                </button>
            </div>
        </div>

        <!-- Selector de examen -->
        <div id="exam-select-section" class="text-center mb-6">
            <p class="mb-4 text-sm text-gray-700">
                Â¿QuÃ© examen querÃ©s practicar?
            </p>
            <div class="flex justify-center gap-4">
                <button
                    type="button"
                    onclick="selectExam('parcial1')"
                    class="px-4 py-2 rounded-lg bg-indigo-500 text-white text-sm font-semibold hover:bg-indigo-600 transition"
                >
                    Primer Parcial
                </button>
                <button
                    type="button"
                    onclick="selectExam('parcial2')"
                    class="px-4 py-2 rounded-lg bg-emerald-500 text-white text-sm font-semibold hover:bg-emerald-600 transition"
                >
                    Segundo Parcial
                </button>
            </div>
            <p class="mt-3 text-xs text-gray-500">
                TambiÃ©n podÃ©s cargar un CSV personalizado desde el menÃº â˜°.
            </p>
        </div>

        <!-- Input oculto para CSV -->
        <input
            type="file"
            id="csv-file-input"
            accept=".csv"
            class="hidden"
        />

        <!-- SecciÃ³n del Quiz -->
        <div id="quiz-section" class="hidden">
            <!-- PuntuaciÃ³n y Progreso + stats en vivo -->
            <div class="mb-4 p-3 bg-gray-100 rounded-lg">
                <div class="flex justify-between items-center">
                    <p class="text-lg font-semibold text-gray-700">
                        PuntuaciÃ³n:
                        <span id="current-score" class="text-indigo-600">0</span>
                        / 50
                    </p>
                    <p class="text-lg font-semibold text-gray-700">
                        Pregunta:
                        <span id="current-progress" class="text-indigo-600">0 / 50</span>
                    </p>
                </div>
                <div class="mt-2 text-sm text-gray-600 flex justify-between">
                    <span>
                        Correctas:
                        <span id="live-correct" class="font-semibold text-emerald-600">0</span>
                    </span>
                    <span>
                        Incorrectas:
                        <span id="live-incorrect" class="font-semibold text-rose-600">0</span>
                    </span>
                    <span>
                        Omitidas:
                        <span id="live-skipped" class="font-semibold text-gray-700">0</span>
                    </span>
                </div>
            </div>

            <!-- Meta: Unidad / Tema -->
            <div id="question-meta" class="text-xs text-gray-500 mb-2 text-center"></div>

            <!-- Pregunta -->
            <div
                id="question-card"
                class="bg-indigo-50 p-6 rounded-xl border-t-4 border-indigo-500 min-h-[150px] flex items-center justify-center"
            >
                <p id="question-text" class="text-xl font-medium text-gray-800 text-center">
                    Cargando pregunta...
                </p>
            </div>

            <!-- Botones -->
            <div class="mt-8 grid grid-cols-3 gap-3">
                <button
                    onclick="handleAnswer('Verdadero')"
                    class="button-correct py-3 rounded-xl text-white font-bold bg-emerald-500 hover:bg-emerald-600 focus:outline-none focus:ring-4 focus:ring-emerald-300"
                >
                    Verdadero
                </button>
                <button
                    onclick="handleAnswer('Falso')"
                    class="button-incorrect py-3 rounded-xl text-white font-bold bg-rose-500 hover:bg-rose-600 focus:outline-none focus:ring-4 focus:ring-rose-300"
                >
                    Falso
                </button>
                <button
                    onclick="handleAnswer('Omitir')"
                    class="py-3 rounded-xl text-gray-700 font-bold bg-gray-200 hover:bg-gray-300 focus:outline-none focus:ring-4 focus:ring-gray-300"
                >
                    Omitir
                </button>
            </div>

            <!-- Feedback -->
            <div
                id="feedback-message"
                class="mt-4 p-3 rounded-lg text-center font-semibold hidden"
            ></div>
        </div>

        <!-- Resultados -->
        <div
            id="results-section"
            class="hidden text-center p-6 bg-green-50 rounded-xl border-t-4 border-green-500"
        >
            <h2 class="text-2xl font-bold text-green-700 mb-3">Â¡Examen terminado!</h2>
            <p class="text-xl text-gray-800 mb-2">
                PuntuaciÃ³n Final:
                <span id="final-score" class="text-4xl font-extrabold text-green-600">0</span>
                / 50
            </p>
            <p class="text-lg text-gray-800 mb-4">
                Nota final (sobre 10):
                <span id="final-grade" class="text-3xl font-bold text-indigo-600">-</span>
            </p>
            <p class="text-md text-gray-600">EstadÃ­sticas:</p>
            <ul class="list-disc list-inside mt-2 mx-auto inline-block text-left">
                <li>Correctas: <span id="stat-correct" class="font-bold">0</span></li>
                <li>Incorrectas: <span id="stat-incorrect" class="font-bold">0</span></li>
                <li>Omitidas: <span id="stat-skipped" class="font-bold">0</span></li>
            </ul>

            <!-- Preguntas incorrectas (desplegable) -->
            <details class="mt-4 text-left max-h-64 overflow-y-auto">
                <summary class="cursor-pointer text-sm text-indigo-700 hover:text-indigo-900 font-semibold">
                    Ver preguntas incorrectas
                </summary>
                <div id="wrong-questions-list" class="mt-2 space-y-3 text-sm text-gray-800"></div>
            </details>

            <button
                onclick="resetQuiz()"
                class="mt-6 py-2 px-6 rounded-full text-white font-bold bg-indigo-500 hover:bg-indigo-600 focus:outline-none focus:ring-4 focus:ring-indigo-300"
            >
                Empezar nuevo intento
            </button>
            
            <button
                onclick="changeExam()"
                class="py-2 px-6 rounded-full text-indigo-600 font-bold bg-white border border-indigo-400 hover:bg-indigo-50 focus:outline-none focus:ring-4 focus:ring-indigo-200"
            >
            Cambiar de examen
            </button>
        </div>

        <!-- Donaciones -->
        <div class="mt-8 text-center">
            <a
                href="https://cafecito.app/darthiss"
                target="_blank"
                class="text-sm text-indigo-600 hover:text-indigo-800 underline"
            >
                Invitame un cafecito â˜•
            </a>
        </div>

        <!-- Error -->
        <div
            id="error-message"
            class="hidden mt-4 p-4 rounded-lg bg-red-100 text-red-700 font-medium"
        ></div>
    </div>
</div>

<script>
    const MAX_QUESTIONS = 50;

    let allQuestions = [];
    let quizQuestions = [];
    let currentQuestionIndex = 0;
    let score = 0; // puede ir de -50 a 50
    let stats = { correct: 0, incorrect: 0, skipped: 0 };
    let isQuizActive = false;
    let answeredQuestions = []; // para mostrar las incorrectas al final
    let currentExam = null; // 'parcial1', 'parcial2', 'custom'

    const csvFileInput = document.getElementById('csv-file-input');
    const quizSection = document.getElementById('quiz-section');
    const resultsSection = document.getElementById('results-section');
    const examSelectSection = document.getElementById('exam-select-section');
    const questionText = document.getElementById('question-text');
    const questionMeta = document.getElementById('question-meta');
    const currentScoreSpan = document.getElementById('current-score');
    const currentProgressSpan = document.getElementById('current-progress');
    const feedbackMessage = document.getElementById('feedback-message');
    const errorMessage = document.getElementById('error-message');
    const liveCorrectSpan = document.getElementById('live-correct');
    const liveIncorrectSpan = document.getElementById('live-incorrect');
    const liveSkippedSpan = document.getElementById('live-skipped');
    const menuButton = document.getElementById('menu-button');
    const menuDropdown = document.getElementById('menu-dropdown');
    const currentExamLabel = document.getElementById('current-exam-label');

    function displayError(message) {
        errorMessage.textContent = message;
        errorMessage.classList.remove('hidden');
    }

    function hideError() {
        errorMessage.classList.add('hidden');
        errorMessage.textContent = '';
    }

    function getRandomElements(arr, num) {
        const shuffled = [...arr].sort(() => 0.5 - Math.random());
        return shuffled.slice(0, num);
    }

    function updateLiveStats() {
        currentScoreSpan.textContent = score;
        liveCorrectSpan.textContent = stats.correct;
        liveIncorrectSpan.textContent = stats.incorrect;
        liveSkippedSpan.textContent = stats.skipped;
    }

    function updateExamLabel() {
        let text = '';
        if (currentExam === 'parcial1') {
            text = 'Practicando: Primer Parcial';
        } else if (currentExam === 'parcial2') {
            text = 'Practicando: Segundo Parcial';
        } else if (currentExam === 'custom') {
            text = 'Practicando: Examen personalizado';
        } else {
            text = '';
        }
        currentExamLabel.textContent = text;
    }

    function initQuizFromQuestions(questions) {
        if (!questions || questions.length === 0) {
            displayError("No se encontraron preguntas vÃ¡lidas en el CSV.");
            return;
        }

        if (questions.length < MAX_QUESTIONS) {
            displayError(
                `Advertencia: solo se encontraron ${questions.length} preguntas. Se utilizarÃ¡n todas ellas.`
            );
            quizQuestions = [...questions];
        } else {
            quizQuestions = getRandomElements(questions, MAX_QUESTIONS);
        }

        score = 0;
        currentQuestionIndex = 0;
        stats = { correct: 0, incorrect: 0, skipped: 0 };
        answeredQuestions = [];
        isQuizActive = true;

        examSelectSection.classList.add('hidden');
        quizSection.classList.remove('hidden');
        resultsSection.classList.add('hidden');
        hideError();

        updateExamLabel();
        updateLiveStats();
        displayQuestion();
    }

    function parseCSV(csvText) {
        const lines = csvText
            .split("\n")
            .map(line => line.trim())
            .filter(line => line !== "");
        const questions = [];

        lines.forEach((line, index) => {
            // Intentar primero con ; y si no, con tab
            let columns = line.split(";").map(col => col.trim());
            if (columns.length === 1) {
                columns = line.split("\t").map(col => col.trim());
            }

            if (!columns || columns.length < 2) return;

            // Detectar header y saltearlo
            const upperFirst = columns[0].toUpperCase();
            if (index === 0 && (upperFirst.includes("UNIDAD") || upperFirst.includes("AFIRMACION"))) {
                return;
            }

            let unidad = "";
            let tema = "";
            let statement = "";
            let answerRaw = "";

            if (columns.length >= 4) {
                // Formato nuevo: UNIDAD, TEMA, AFIRMACION, RESPUESTA
                unidad = columns[0];
                tema = columns[1];
                statement = (columns[2] || "").replace(/"/g, "");
                answerRaw = (columns[3] || "").toLowerCase();
            } else {
                // Formato viejo: AFIRMACION;RESPUESTA
                statement = (columns[0] || "").replace(/"/g, "");
                answerRaw = (columns[1] || "").toLowerCase();
            }

            if (statement && (answerRaw === "verdadero" || answerRaw === "falso")) {
                questions.push({
                    unidad: unidad || null,
                    tema: tema || null,
                    statement: statement,
                    correctAnswer: answerRaw === "verdadero"
                });
            }
        });

        return questions;
    }

    async function loadExam(examId) {
        try {
            currentExam = examId;
            updateExamLabel();

            let fileName;
            if (examId === 'parcial1') {
                fileName = "preguntas_parcial1.csv";
            } else if (examId === 'parcial2') {
                fileName = "preguntas_parcial2.csv";
            } else {
                fileName = "preguntas.csv";
            }

            const response = await fetch(fileName);
            if (!response.ok) {
                throw new Error("No se pudo cargar " + fileName);
            }
            const text = await response.text();
            allQuestions = parseCSV(text);
            initQuizFromQuestions(allQuestions);
        } catch (error) {
            console.error(error);
            displayError(
                "No se pudo cargar el archivo del examen seleccionado. VerificÃ¡ que exista en el repo."
            );
        }
    }

    function displayQuestion() {
        if (currentQuestionIndex < quizQuestions.length) {
            const question = quizQuestions[currentQuestionIndex];
            questionText.textContent = question.statement;
            currentProgressSpan.textContent = `${currentQuestionIndex + 1} / ${quizQuestions.length}`;

            // Mostrar Unidad / Tema si existen
            if (question.unidad || question.tema) {
                const parts = [];
                if (question.unidad) parts.push(`Unidad: ${question.unidad}`);
                if (question.tema) parts.push(`Tema: ${question.tema}`);
                questionMeta.textContent = parts.join(" Â· ");
            } else {
                questionMeta.textContent = "";
            }

            feedbackMessage.classList.add("hidden");
        } else {
            endQuiz();
        }
    }

    function handleAnswer(userChoice) {
        if (!isQuizActive || currentQuestionIndex >= quizQuestions.length) return;

        const question = quizQuestions[currentQuestionIndex];
        let points = 0;
        let message = "";
        let isCorrectFlag = null;

        if (userChoice === "Omitir") {
            points = 0;
            stats.skipped++;
            message = "Has omitido la pregunta. PuntuaciÃ³n: +0.";
            feedbackMessage.classList.remove("bg-red-100", "bg-green-100", "text-red-700", "text-green-700");
            feedbackMessage.classList.add("bg-gray-200", "text-gray-700");
        } else {
            const choiceIsTrue = userChoice === "Verdadero";
            const isCorrect = (choiceIsTrue === question.correctAnswer);
            isCorrectFlag = isCorrect;

            if (isCorrect) {
                points = 1; // correcta suma 1
                score += points;
                stats.correct++;
                message = `Â¡Correcto! Respuesta: ${
                    question.correctAnswer ? "Verdadero" : "Falso"
                }. (+1)`;
                feedbackMessage.classList.remove(
                    "bg-red-100",
                    "bg-gray-200",
                    "text-gray-700",
                    "text-red-700"
                );
                feedbackMessage.classList.add("bg-green-100", "text-green-700");
            } else {
                points = -1; // incorrecta resta 1
                score += points;
                stats.incorrect++;
                message = `Incorrecto. La correcta era: ${
                    question.correctAnswer ? "Verdadero" : "Falso"
                }. (-1)`;
                feedbackMessage.classList.remove(
                    "bg-green-100",
                    "bg-gray-200",
                    "text-gray-700",
                    "text-green-700"
                );
                feedbackMessage.classList.add("bg-red-100", "text-red-700");
            }
        }

        // Registrar la respuesta
        answeredQuestions.push({
            unidad: question.unidad,
            tema: question.tema,
            statement: question.statement,
            correctAnswer: question.correctAnswer,
            userAnswer: userChoice,
            isCorrect: isCorrectFlag
        });

        updateLiveStats();
        feedbackMessage.textContent = message;
        feedbackMessage.classList.remove("hidden");

        setTimeout(() => {
            currentQuestionIndex++;
            displayQuestion();
        }, 800);
    }

    function calcularNotaFinal(puntaje) {
        // FÃ³rmula: 4 + (puntaje - 30) * 3 / 10
        let nota = 4 + (puntaje - 30) * 3 / 10;

        // Limitar entre 1 y 10 por prolijidad
        if (nota < 1) nota = 1;
        if (nota > 10) nota = 10;

        return nota.toFixed(1);
    }

    function buildWrongQuestionsList() {
        const container = document.getElementById("wrong-questions-list");
        const wrongQuestions = answeredQuestions.filter(
            q => q.isCorrect === false // solo las realmente incorrectas (no omitidas)
        );

        if (wrongQuestions.length === 0) {
            container.innerHTML = '<p class="text-sm text-gray-600">No te equivocaste en ninguna ðŸ’ª</p>';
            return;
        }

        let html = "";
        wrongQuestions.forEach((item, index) => {
            const unidadTemaParts = [];
            if (item.unidad) unidadTemaParts.push(`Unidad: ${item.unidad}`);
            if (item.tema) unidadTemaParts.push(`Tema: ${item.tema}`);
            const unidadTemaText = unidadTemaParts.join(" Â· ");

            html += `
                <div class="border border-gray-200 rounded-md p-3 bg-white">
                    <div class="text-xs text-gray-500 mb-1">
                        ${unidadTemaText || ""}
                    </div>
                    <p class="font-medium mb-1">${index + 1}. ${item.statement}</p>
                    <p class="mb-0.5">
                        Tu respuesta:
                        <span class="font-semibold text-rose-600">
                            ${item.userAnswer === "Verdadero" || item.userAnswer === "Falso" ? item.userAnswer : "â€”"}
                        </span>
                    </p>
                    <p>
                        Correcta:
                        <span class="font-semibold text-emerald-700">
                            ${item.correctAnswer ? "Verdadero" : "Falso"}
                        </span>
                    </p>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    function endQuiz() {
        isQuizActive = false;
        quizSection.classList.add("hidden");
        resultsSection.classList.remove("hidden");
        feedbackMessage.classList.add("hidden");

        document.getElementById("final-score").textContent = score;
        document.getElementById("stat-correct").textContent = stats.correct;
        document.getElementById("stat-incorrect").textContent = stats.incorrect;
        document.getElementById("stat-skipped").textContent = stats.skipped;

        const notaFinal = calcularNotaFinal(score);
        document.getElementById("final-grade").textContent = notaFinal;

        buildWrongQuestionsList();
    }

    // --- MenÃº burger ---
    menuButton.addEventListener("click", (event) => {
        event.stopPropagation();
        menuDropdown.classList.toggle("hidden");
    });

    menuDropdown.addEventListener("click", (event) => {
        // Evitar que el click dentro del menÃº cierre por el listener global
        event.stopPropagation();
    });

    // Cerrar menÃº al hacer click fuera
    document.addEventListener("click", (event) => {
        if (
            !menuDropdown.classList.contains("hidden") &&
            !menuDropdown.contains(event.target) &&
            !menuButton.contains(event.target)
        ) {
            menuDropdown.classList.add("hidden");
        }
    });

    // Inicio: solo mostrar selector de examen
    document.addEventListener("DOMContentLoaded", () => {
        quizSection.classList.add('hidden');
        resultsSection.classList.add('hidden');
        examSelectSection.classList.remove('hidden');
        updateExamLabel();
    });

    // Funciones para menÃº / exam selector
    function triggerUpload() {
        menuDropdown.classList.add("hidden");
        csvFileInput.click();
    }

    function selectExam(examId) {
        hideError();
        examSelectSection.classList.add('hidden');
        loadExam(examId);
    }

    function changeExam() {
        menuDropdown.classList.add("hidden");
        isQuizActive = false;
        quizSection.classList.add('hidden');
        resultsSection.classList.add('hidden');
        examSelectSection.classList.remove('hidden');
        questionMeta.textContent = '';
        questionText.textContent = 'SeleccionÃ¡ un examen para comenzar.';
        currentExam = null;
        updateExamLabel();
    }

    function resetQuiz() {
        menuDropdown.classList.add("hidden");
        if (!allQuestions || allQuestions.length === 0) {
            displayError("No hay preguntas cargadas para reiniciar.");
            return;
        }
        initQuizFromQuestions(allQuestions);
    }

    // Upload opcional para reemplazar el banco
    csvFileInput.addEventListener("change", event => {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = e => {
            try {
                allQuestions = parseCSV(e.target.result);
                currentExam = 'custom';
                initQuizFromQuestions(allQuestions);
            } catch (error) {
                console.error("Error al procesar el archivo:", error);
                displayError(
                    "Error al leer o procesar el archivo CSV. AsegÃºrate de que el formato sea correcto (UNIDAD;TEMA;AFIRMACION;RESPUESTA)."
                );
            }
        };
        reader.readAsText(file);
    });
</script>
</body>
</html>
